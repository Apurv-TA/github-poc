name: final workflow by merge
on:
  pull_request:
    branches: [release, uat, qa, dev*]
    types : [closed]
  push:
    branches: [dev*]
    
jobs:  
  tag-release:
    if: github.event.pull_request.merged == true
    name: 'tag-release'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: get the release version
      id: latest_release
      run: echo "::set-output name=tag::$(bash scripts/auto_release_tag.sh)"
    outputs:
        current_release: ${{steps.latest_release.outputs.tag}}

  fetch-branch-name:
    name: Extract branch name
    runs-on: ubuntu-latest
    steps:
    - name: Extract branch name
      id: current_branch
      run: echo "::set-output name=branch::$(echo ${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}})"
    outputs:
        latest_branch: ${{steps.current_branch.outputs.branch}}

  get-tag:
    name: Get the tag for docker image
    runs-on: ubuntu-latest
    needs: [tag-release, fetch-branch-name]
    steps:
    - uses: actions/checkout@v3
    - name: Get the tag for Docker image
      id: image_tag
      env:
        TAG: ${{needs.tag-release.outputs.current_release}}
        BRANCH: ${{needs.fetch-branch-name.outputs.latest_branch}}
      run: echo "::set-output name=tag::$(bash scripts/branch.sh -b $BRANCH -v $TAG)"
    outputs:
      release_tag: ${{steps.image_tag.outputs.tag}}

  build-docker-backend:
    name: 'Building the backend docker image'
    runs-on: ubuntu-latest
    needs: [get-tag]
    steps:
      - uses: actions/checkout@v2
      - name: Building and tagging the backend docker image
        env:
          IMAGE_TAG: ${{needs.get-tag.outputs.release_tag }}
        run: |
          docker build -t mcdapi:$IMAGE_TAG -f env/docker_mcdapi/Dockerfile .

  build-docker-frontend:
    name: 'Building the frontend docker image'
    runs-on: ubuntu-latest
    needs: [get-tag]
    steps:
      - uses: actions/checkout@v2
      - name: Building and tagging the frontend docker image
        env:
          IMAGE_TAG: ${{needs.get-tag.outputs.release_tag }}
        run: |
          docker build -t mcdui:$IMAGE_TAG -f env/docker_mcdui/Dockerfile .

  build-docker-nginx:
    name: 'Building the nginx docker image'
    runs-on: ubuntu-latest
    needs: [get-tag]
    steps:
      - uses: actions/checkout@v2
      - name: Building and tagging the nginx docker image
        env:
          IMAGE_TAG: ${{needs.get-tag.outputs.release_tag }}
        run: |
          docker build -t nginx:$IMAGE_TAG -f env/docker_nginx/Dockerfile .
